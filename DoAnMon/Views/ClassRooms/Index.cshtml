@using DoAnMon.IdentityCudtomUser
@using Microsoft.AspNetCore.Identity
@inject SignInManager<CustomUser> SignInManager
@inject UserManager<CustomUser> UserManager
@inject SignInManager<CustomUser> _signInManager
@using static DoAnMon.Models.ClassroomViewModel
@model List<ClassRoomViewModel>

@{
	ViewData["Title"] = "Classrooms";
	Layout = "~/Views/Shared/_Layout.cshtml";
    var user = await UserManager.GetUserAsync(User);
}

<style>
    .left-column_indexClassroom {
        width: 20%;
        border: 1px solid #ddd;
    }

    .btn-custom-indexControl{
        width: 85%;
        border-radius: 0 30px 30px 0;
        text-align: left;
        font-family: "Lobster", serif;
        font-size: 20px;
        margin-top: 5px;
    }

    .btn-custom-indexControl:focus, .btn-custom-indexControl:active:focus{
        outline: 2px solid blue;
    }

    .QR-container{
        display: grid;
        place-content: center;
        height: 80%;
    }

    #classroomList {
        min-height: 500px;
        overflow-y: auto;
    }

    .classrooms-content {
        padding: 20px;
        background-color: #c2c0c0;
        height: 100%;
        display: flex;
    }

    .classroom{
        height: fit-content;
    }
</style>

<div class="container-classrooms-trangchinh" style="margin-top: 80px;display: flex;min-height: 500px;">
   <div class="left-column_indexClassroom">
        @* <div class="image-frame">
            <img src="~/Imgs_avtUser/@user.UrlAvt" alt="Hình ảnh">
        </div>
        <center>
            <p style="font-weight: bold; font-size: 20px;">@user.Name</p>
        </center>
        <ul class="vertical-menu1">
            <li><a href="/Identity/Account/Manage/Index">Thông tin cá nhân</a></li>
        </ul> *@
        <button type="button" class="btn btn-light btn-custom-indexControl" onclick="location.href='/ClassRooms'"><i class="fa-solid fa-house-chimney fa-xl" style="color: #000; margin-right: 30px;"></i> Màn hình chính</button>
        <button type="button" class="btn btn-light btn-custom-indexControl" onclick="location.href='/Notifications'"><i class="fa-solid fa-bell fa-xl" style="color: #000; margin-right: 35px;"></i> Thông báo mới</button>
        @if (User.IsInRole("Teacher") || User.IsInRole("Admin"))
         {
            <button type="button" class="btn btn-light btn-custom-indexControl" onclick="location.href='/ClassRooms/Create'"><i class="fa-solid fa-plus fa-xl" style="color: #000; margin-right: 35px;"></i> Tạo lớp mới</button>
         }
        <button data-toggle="modal" data-target="#JoinModal" type="button" class="btn btn-light btn-custom-indexControl"><img src="https://cdn-icons-png.flaticon.com/512/12366/12366453.png" alt="Alternate Text" width="26.25px" height="30.4" style="margin-right:35px; " /> Tham gia lớp học</button>
        <hr style="border-top: 2px solid #ddd; margin: 10px auto;" />
    </div>
    <!-- Modal join-->
    <div class="modal fade" id="JoinModal" tabindex="-1" role="dialog" aria-labelledby="JoinModelLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="JoinModelLabel" style="font-family: 'Lobster', serif; letter-spacing: 2px;">Tham gia lớp học</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="container text-center" style="width: 100%;">
                        <div class="row row-cols-2" style="display: flex;">
                            <div class="col" style="width: 50%;">
                                <h4 style="font-family: 'Itim', serif; font-weight: bold;">Tham gia bằng mã lớp học</h4>
                                <form id="joinRoomForm" action="/ClassRooms/JoinClassV1" method="post">
                                    <div class="col-md-12" style="width: 100%">
                                        <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                                        <div class="form-group">
                                            <label for="ClassRoomId" class="control-label" style="color: black; text-align: left; display: block; margin:10px 0; font-family: 'Itim', serif; font-weight: normal;">Mã phòng học:</label>
                                            <input name="ClassRoomId" id="ClassRoomId" class="form-control custom-input-width" required />
                                            <span id="ClassRoomIdError" class="text-danger"></span>
                                        </div>
                                    </div>
                                    <div class="modal-footer" style="border-top: 1px solid #e5e5e5; padding-top: 10px">
                                        <input style="font-size: 16px; font-weight:bold; width: 100%; font-family: 'Lobster', serif; letter-spacing: 2px; background-color: #B3E5BE; color: #52575D" type="submit" value="Tham gia" class="btn btn-primary" />
                                    </div>
                                </form>
                            </div>
                            <div class="col" style="width: 50%;">
                                <h4 style="font-family: 'Itim', serif; font-weight: bold;">Tham gia bằng mã QR</h4>
                                <div class="QR-container">
                                    <button id="scanButton" class="btn btn-info">Quét Mã QR</button>
                                    <div id="cameraModal" class="modal">
                                        <div class="modal-content" style="align-items: center;justify-content: center; width: 100%; height: 100%">
                                            <span class="close">&times;</span>
                                            <video id="qrScanner" width="100%" height="90%" autoplay style="align-items: center;justify-content: center; object-fit: cover;"></video>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-primary" style="font-family: 'Lobster', serif" data-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
    <div class="main-content" style="flex: 1;">
     @* <!-- Nội dung main content -->
         <button class="plus-button" title="Tạo hoặc tham gia lớp học" onclick="toggleOptions()">
            <svg xmlns="http://www.w3.org/2000/svg" width="35" height="35" viewBox="0 0 24 24">
                <path d="M20 13h-7v7h-2v-7H4v-2h7V4h2v7h7v2z" />
            </svg>
        </button>
        <div id="class-options-container" class="hidden">
            <div class="options-frame">
                @if (User.IsInRole("Teacher") || User.IsInRole("Admin"))
                {

                <div class="option">
                    <a href="/ClassRooms/Create" title="Create Classroom" style="text-decoration:none;">
                        <p style="font-size: 16px; padding-left: 5px; color: black; margin: 0;">Tạo mới</p>
                    </a>
                </div>
                }
                <div class="option">
                    <button id="btnAddRoom" data-toggle="modal" data-target="#joinRoomModal" style="font-size: 16px;background-color: transparent; color:black; border-color:transparent;">Tham gia</button>
                </div>
                <div class="option">
                    <button id="scanButton" style="font-size: 16px; border-color:transparent;background-color: transparent">Quét Mã QR</button>
                </div>
            </div>
        </div>
        <div id="joinRoomModal" class="modal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header" style="margin-bottom: 10px; border-bottom: none">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                        <h5 class="modal-title" style="font-size:30px;font-weight:bold; color: #FA7070">THAM GIA PHÒNG HỌC</h5>
                    </div>


                    <form id="joinRoomForm" action="/ClassRooms/JoinClassV1" method="post">
                        <div class="col-md-12" style="width: 100%">
                            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
                            <div class="form-group">
                                <label for="ClassRoomId" class="control-label" style="color: black; text-align: left; display: block; margin:10px 0">Mã phòng học:</label>
                                <input name="ClassRoomId" id="ClassRoomId" class="form-control custom-input-width" required />
                                <span id="ClassRoomIdError" class="text-danger"></span>
                            </div>
                        </div>
                        <div class="modal-footer" style="border-top: 1px solid #e5e5e5; padding-top: 10px">
                            <button type="button" class="btn btn-secondary" data-dismiss="modal" style="font-weight:bold; background-color: grey; font-size: 16px">Đóng</button>
                            <input style="font-size: 16px; font-weight:bold" type="submit" value="Tham gia" class="btn btn-primary" />
                        </div>
                    </form>
                </div>
            </div>
        </div>
        <div id="cameraModal" class="modal">
            <div class="modal-content" style="align-items: center;justify-content: center;">
                <span class="close">&times;</span>
                <video id="qrScanner" width="400" height="400" autoplay style="align-items: center;justify-content: center;"></video>
            </div>
        </div>
        *@
        <div id="classroomList" class="classrooms-content">
            @{
                if (Model != null)
                {
                    @foreach (var viewModel in Model)
                    {
                        <div class="classroom" data-id="@viewModel.ClassRoom.Id">
                            <div class="card-top" style="background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url(/images/@viewModel.ClassRoom.backgroundUrl);background-size: cover; background-position:center;color: white;">
                                <h2 style="font-family: Poppins, sans-serif; font-size: 20px">@viewModel.ClassRoom.Name</h2>
                                <div class="meta" style="font-family: Poppins, sans-serif; font-size: 12px;font-weight:300;color: white;">@viewModel.ClassRoom.Description</div>
                                <p style="padding-top: 4%; font-family: Poppins, sans-serif; font-size: 15px; font-weight:500">@viewModel.Owner.Name</p>
                            </div>
                            <div class="card-bottom">
                                <img class="PNzAWd" aria-hidden="true" src="/Imgs_avtUser/@viewModel.Owner.UrlAvt">
                                <a href="@viewModel.ClassRoom.RoomOnline&User=@user.Id&class=@viewModel.ClassRoom.Id" id="diemDanhBtn" data-class-id="@viewModel.ClassRoom.Id" class="btn btn-primary btn-info btn-custom" target="_blank" style="font-family: Poppins, sans-serif; font-size: 14px;font-weight: 600;">Giảng đường</a>
                                <a asp-action="Details" asp-route-id="@viewModel.ClassRoom.Id" class="btn btn-primary btn-info btn-custom" style="margin-top: 10px; font-family: Poppins, sans-serif; font-size: 14px;font-weight:600;">Lớp học</a>
                            </div>
                        </div>
                    }
                }
            }
        </div> 

    </div>
</div>



<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/popperjs/core@1.16.1/dist/umd/popper.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.14.0/Sortable.min.js"></script>


@if (!string.IsNullOrEmpty(ViewBag.StatusMessage))
{
    <script>alert('@ViewBag.StatusMessage');</script>
}
<script>

    function toggleOptions() {
        var plusButton = document.getElementById("plus-button");
        var options = document.getElementById("class-options-container");
        options.classList.toggle("hidden");

    }

    function hideOptions() {
        var joinFrame = document.getElementById("join-frame");
        joinFrame.classList.remove("hidden");
    }

    function showJoinFrame() {
        hideOptions();
    }
</script>
<script>
    $(document).ready(function () {
        $("#btnAddRoom").click(function () {
            $("#addRoomModal").modal('show');
        });


        $(".btn-info").click(function () {
            $(this).closest("tr").find(".room-description").toggle();
        });
    });
</script>
<script>
    $(document).ready(function () {
        $('#scanButton').click(function () {
            // Hiển thị modal
            $('#cameraModal').css('display', 'block');

            // Bắt đầu quét mã QR khi modal được mở
            startQRScanning();
        });

        // Đóng modal khi nhấn vào nút đóng hoặc nút close
        $('.close').click(function () {
            $('#cameraModal').css('display', 'none');
            stopQRScanning();
        });

        // Đóng modal khi nhấn ESC
        $(document).keyup(function (e) {
            if (e.key === "Escape") { // escape key maps to keycode `27`
                $('#cameraModal').css('display', 'none');
                stopQRScanning();
            }
        });
    });

    function startQRScanning() {
        const video = document.getElementById('qrScanner');

        // Truy cập vào camera và stream video
        navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
            .then(stream => {
                video.srcObject = stream;
                video.setAttribute('playsinline', true);
                video.play();
                // Bắt đầu quét mã QR
                tick();
            });

        function tick() {
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                if (code) {
                    // Hiển thị nội dung mã QR trong cửa sổ thông báo (alert)
                    Swal.fire({
                        title: 'QR Code content',
                        text: code.data,
                        icon: 'success',
                        showConfirmButton: false,
                        timer: 1500
                    });
                    // Gọi hàm để xử lý dữ liệu mã QR
                    savedata(code.data);
                    stopQRScanning();
                }
            }
            // Lặp lại quét mã QR
            requestAnimationFrame(tick);
        }
    }

    function stopQRScanning() {
        const video = document.getElementById('qrScanner');
        const stream = video.srcObject;
        const tracks = stream.getTracks();

        tracks.forEach(track => track.stop());
        video.srcObject = null;
    }

    function savedata(qrData) {
        // Gửi dữ liệu mã QR đến server để lưu trữ
        $.ajax({
            url: '/ClassRooms/JoinClassWithQRCode',
            type: 'POST',
            data: { qrData: qrData },
            success: function (response) {
                if (response.success) {
                    // Chuyển hướng hoặc hiển thị thông báo thành công
                    window.location.href = '/ClassRooms';
                } else {
                    // Hiển thị thông báo lỗi nếu cần
                    alert('Có lỗi xảy ra: ' + response.error);
                }
            },
            error: function (xhr, status, error) {
                // Xử lý lỗi nếu cần
                console.error('Error:', error);
            }
        });
    }
</script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        $('#diemDanhBtn').on('click', function (event) {
            event.preventDefault(); // Prevent the default link action
            var classId = $(this).data('class-id');
            var roomOnlineUrl = $(this).attr('href');
            var ajaxUrl = '@Url.Action("DiemDanhIn", "ClassRooms")';

            $.post("/ClassRooms/DiemDanhIn", { classId: classId }, function (data) {
                if (data.success) {
                    console.log('Điểm danh thành công');
                    window.open(roomOnlineUrl, '_blank');
                }
                else {
                    console.log(data.error);
                    alert(data.error);
                    console.log('Điểm danh thất bại');
                }
            });
        });
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        var sortable = new Sortable(document.getElementById('classroomList'), {
            animation: 150,
            scroll: true, // Bật tính năng cuộn tự động
            scrollSensitivity: 30, // Độ nhạy của việc cuộn (càng lớn thì cuộn càng nhanh)
            scrollSpeed: 10, // Tốc độ cuộn
            onEnd: function (evt) {
                // Get the new order of classroom IDs
                var order = sortable.toArray();
                console.log("New order: ", order);
                // Send the new order to the server
                fetch('/ClassRooms/UpdateOrder', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'  // Include Anti-Forgery Token if necessary
                    },
                    body: JSON.stringify(order)
                }).then(response => {
                    if (response.ok) {
                        console.log('Order updated successfully');
                    } else {
                        console.error('Failed to update order');
                    }
                }).catch(error => {
                    console.error('Error:', error);
                });
            }
        });
    });
</script>



